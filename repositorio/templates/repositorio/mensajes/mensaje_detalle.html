{% extends "repositorio/base.html" %}
{% block title %}Detalle del mensaje{% endblock %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Mensaje</h2>

        <div class="d-flex gap-2">

            {# Volver al dashboard correspondiente (docente/estudiante) #}
            {% if dashboard_url %}
                <a href="{% url dashboard_url %}" class="btn btn-outline-secondary btn-sm">
                    Volver a inicio
                </a>
            {% endif %}

            <a href="{% url 'bandeja_entrada' %}" class="btn btn-outline-secondary btn-sm">
                Ver recibidos
            </a>

            <a href="{% url 'mensajes_enviados' %}" class="btn btn-outline-secondary btn-sm">
                Ver enviados
            </a>

            <a href="{% url 'redactar_mensaje' %}?para={{ usuario_respuesta.id }}&asunto={{ mensaje.asunto|urlencode }}&respuesta_de={{ mensaje.id }}"
               class="btn btn-primary btn-sm">
                Responder
            </a>

            {# ÚNICO botón de eliminar: lo ven remitente o destinatario #}
            {% if mensaje.remitente == request.user or mensaje.destinatario == request.user %}
                <form action="{% url 'eliminar_mensaje' mensaje.id %}" method="post"
                      onsubmit="return confirm('¿Seguro que deseas eliminar este mensaje de tu bandeja?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        Eliminar
                    </button>
                </form>
            {% endif %}

        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">

            {% if mensaje.respuesta_de %}
                <p class="text-muted small">
                    Respuesta a: <strong>{{ mensaje.respuesta_de.asunto }}</strong>
                </p>
            {% endif %}

            <p class="mb-1"><strong>De:</strong> {{ mensaje.remitente.username }}</p>
            <p class="mb-1"><strong>Para:</strong> {{ mensaje.destinatario.username }}</p>
            <p class="mb-3"><strong>Fecha:</strong> {{ mensaje.creado|date:"d/m/Y H:i" }}</p>

            <h5 class="mb-3"><strong>Asunto:</strong> {{ mensaje.asunto }}</h5>

            <hr>

            <p style="white-space: pre-wrap;">{{ mensaje.contenido }}</p>

        </div>
    </div>

</div>
{% endblock %}
